---
# =============================================================================
# Bootstrap Workflow
# =============================================================================
# Initial infrastructure setup including VPC, backend, and IAM
#
# Usage:
#   atmos workflow bootstrap -f bootstrap.yaml tenant=<tenant> account=<account> environment=<environment>
#
# This workflow creates:
#   1. Terraform backend (S3 + DynamoDB)
#   2. Base IAM roles and policies
#   3. VPC networking foundation
#   4. Security groups and NACLs
# =============================================================================

name: bootstrap
description: "Initial infrastructure setup - creates backend, IAM, and VPC foundation"

workflows:
  # =============================================================================
  # Full Bootstrap - Orchestrates all bootstrap components
  # =============================================================================
  full:
    description: "Complete bootstrap sequence - backend, IAM, networking"
    steps:
      - name: "validate-parameters"
        description: "Validate required parameters and AWS access"
        run:
          command: |
            set -euo pipefail

            # Colors
            RED='\033[0;31m'
            GREEN='\033[0;32m'
            YELLOW='\033[1;33m'
            BLUE='\033[0;34m'
            WHITE='\033[1;37m'
            NC='\033[0m'

            log_info() { echo -e "${BLUE}[INFO]${NC} $*"; }
            log_success() { echo -e "${GREEN}[SUCCESS]${NC} $*"; }
            log_error() { echo -e "${RED}[ERROR]${NC} $*"; }
            log_warning() { echo -e "${YELLOW}[WARNING]${NC} $*"; }

            echo -e "\n${WHITE}=== Bootstrap Workflow ===${NC}\n"
            echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

            # Validate required parameters
            MISSING_PARAMS=()
            [[ -z "${tenant:-}" ]] && MISSING_PARAMS+=("tenant")
            [[ -z "${account:-}" ]] && MISSING_PARAMS+=("account")
            [[ -z "${environment:-}" ]] && MISSING_PARAMS+=("environment")

            if [[ ${#MISSING_PARAMS[@]} -gt 0 ]]; then
              log_error "Missing required parameters: ${MISSING_PARAMS[*]}"
              echo
              echo "Usage:"
              echo "  atmos workflow bootstrap -f bootstrap.yaml tenant=<tenant> account=<account> environment=<environment>"
              echo
              echo "Example:"
              echo "  atmos workflow bootstrap -f bootstrap.yaml tenant=fnx account=dev environment=testenv-01"
              exit 1
            fi

            STACK="${tenant}-${account}-${environment}"
            REGION="${region:-eu-west-2}"

            echo "Configuration:"
            echo "  Stack:       $STACK"
            echo "  Tenant:      ${tenant}"
            echo "  Account:     ${account}"
            echo "  Environment: ${environment}"
            echo "  Region:      $REGION"

            # Validate AWS credentials
            log_info "Validating AWS credentials..."
            if ! aws sts get-caller-identity >/dev/null 2>&1; then
              log_error "Invalid AWS credentials. Please configure AWS CLI."
              exit 1
            fi

            AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query 'Account' --output text)
            AWS_USER_ARN=$(aws sts get-caller-identity --query 'Arn' --output text)
            echo "  AWS Account: $AWS_ACCOUNT_ID"
            echo "  AWS ARN:     $AWS_USER_ARN"

            log_success "Parameter validation complete"
          env:
            AWS_SDK_LOAD_CONFIG: 1

      - name: "create-backend"
        description: "Create Terraform backend infrastructure"
        run:
          command: |
            set -euo pipefail

            # Colors
            GREEN='\033[0;32m'
            BLUE='\033[0;34m'
            YELLOW='\033[1;33m'
            WHITE='\033[1;37m'
            NC='\033[0m'

            log_info() { echo -e "${BLUE}[INFO]${NC} $*"; }
            log_success() { echo -e "${GREEN}[SUCCESS]${NC} $*"; }

            echo -e "\n${WHITE}=== Step: Create Backend Infrastructure ===${NC}\n"

            REGION="${region:-eu-west-2}"
            BUCKET_NAME="${tenant}-${account}-${environment}-terraform-state"
            DYNAMODB_TABLE="${tenant}-${account}-${environment}-terraform-locks"

            echo "Backend Resources:"
            echo "  S3 Bucket:      $BUCKET_NAME"
            echo "  DynamoDB Table: $DYNAMODB_TABLE"
            echo "  Region:         $REGION"

            # Create S3 bucket if not exists
            if aws s3api head-bucket --bucket "$BUCKET_NAME" 2>/dev/null; then
              log_info "S3 bucket already exists: $BUCKET_NAME"
            else
              log_info "Creating S3 bucket: $BUCKET_NAME"

              if [[ "$REGION" == "us-east-1" ]]; then
                aws s3api create-bucket --bucket "$BUCKET_NAME" --region "$REGION"
              else
                aws s3api create-bucket --bucket "$BUCKET_NAME" --region "$REGION" \
                  --create-bucket-configuration LocationConstraint="$REGION"
              fi

              # Enable versioning
              aws s3api put-bucket-versioning --bucket "$BUCKET_NAME" \
                --versioning-configuration Status=Enabled

              # Enable encryption
              aws s3api put-bucket-encryption --bucket "$BUCKET_NAME" \
                --server-side-encryption-configuration '{
                  "Rules": [{
                    "ApplyServerSideEncryptionByDefault": {"SSEAlgorithm": "AES256"},
                    "BucketKeyEnabled": true
                  }]
                }'

              # Block public access
              aws s3api put-public-access-block --bucket "$BUCKET_NAME" \
                --public-access-block-configuration '{
                  "BlockPublicAcls": true,
                  "IgnorePublicAcls": true,
                  "BlockPublicPolicy": true,
                  "RestrictPublicBuckets": true
                }'

              # Add lifecycle policy for old versions
              aws s3api put-bucket-lifecycle-configuration --bucket "$BUCKET_NAME" \
                --lifecycle-configuration '{
                  "Rules": [{
                    "ID": "ExpireOldVersions",
                    "Status": "Enabled",
                    "Filter": {},
                    "NoncurrentVersionExpiration": {"NoncurrentDays": 90}
                  }]
                }'

              log_success "S3 bucket created and configured"
            fi

            # Create DynamoDB table if not exists
            if aws dynamodb describe-table --table-name "$DYNAMODB_TABLE" --region "$REGION" >/dev/null 2>&1; then
              log_info "DynamoDB table already exists: $DYNAMODB_TABLE"
            else
              log_info "Creating DynamoDB table: $DYNAMODB_TABLE"

              aws dynamodb create-table \
                --table-name "$DYNAMODB_TABLE" \
                --attribute-definitions AttributeName=LockID,AttributeType=S \
                --key-schema AttributeName=LockID,KeyType=HASH \
                --billing-mode PAY_PER_REQUEST \
                --region "$REGION" \
                --tags Key=ManagedBy,Value=atmos Key=Tenant,Value="${tenant}" Key=Environment,Value="${environment}"

              log_info "Waiting for table to become active..."
              aws dynamodb wait table-exists --table-name "$DYNAMODB_TABLE" --region "$REGION"

              # Enable point-in-time recovery
              aws dynamodb update-continuous-backups \
                --table-name "$DYNAMODB_TABLE" \
                --region "$REGION" \
                --point-in-time-recovery-specification PointInTimeRecoveryEnabled=true

              log_success "DynamoDB table created and configured"
            fi

            log_success "Backend infrastructure ready"
          env:
            AWS_SDK_LOAD_CONFIG: 1

      - name: "deploy-iam"
        description: "Deploy IAM roles and policies"
        run:
          command: |
            set -euo pipefail

            GREEN='\033[0;32m'
            BLUE='\033[0;34m'
            WHITE='\033[1;37m'
            NC='\033[0m'

            log_info() { echo -e "${BLUE}[INFO]${NC} $*"; }
            log_success() { echo -e "${GREEN}[SUCCESS]${NC} $*"; }

            echo -e "\n${WHITE}=== Step: Deploy IAM Roles ===${NC}\n"

            STACK="${tenant}-${account}-${environment}"
            SKIP_IAM="${skip_iam:-false}"

            if [[ "$SKIP_IAM" == "true" ]]; then
              log_info "Skipping IAM deployment (skip_iam=true)"
              exit 0
            fi

            # Check if IAM component exists in the stack
            if atmos describe component iam -s "$STACK" >/dev/null 2>&1; then
              log_info "Deploying IAM component..."

              if atmos terraform plan iam -s "$STACK"; then
                if [[ "${auto_approve:-false}" == "true" ]]; then
                  atmos terraform apply iam -s "$STACK" -auto-approve
                  log_success "IAM component deployed"
                else
                  log_info "IAM plan generated. Set auto_approve=true to apply."
                fi
              else
                log_info "IAM component plan failed or no changes needed"
              fi
            else
              log_info "IAM component not found in stack. Skipping."
            fi
          env:
            AWS_SDK_LOAD_CONFIG: 1

      - name: "deploy-vpc"
        description: "Deploy VPC networking foundation"
        run:
          command: |
            set -euo pipefail

            GREEN='\033[0;32m'
            BLUE='\033[0;34m'
            WHITE='\033[1;37m'
            NC='\033[0m'

            log_info() { echo -e "${BLUE}[INFO]${NC} $*"; }
            log_success() { echo -e "${GREEN}[SUCCESS]${NC} $*"; }

            echo -e "\n${WHITE}=== Step: Deploy VPC ===${NC}\n"

            STACK="${tenant}-${account}-${environment}"
            SKIP_VPC="${skip_vpc:-false}"

            if [[ "$SKIP_VPC" == "true" ]]; then
              log_info "Skipping VPC deployment (skip_vpc=true)"
              exit 0
            fi

            # Deploy VPC components
            VPC_COMPONENTS=$(atmos list components -s "$STACK" 2>/dev/null | grep "^vpc" || echo "")

            if [[ -z "$VPC_COMPONENTS" ]]; then
              log_info "No VPC components found in stack. Skipping."
              exit 0
            fi

            for component in $VPC_COMPONENTS; do
              log_info "Deploying $component..."

              if atmos terraform plan "$component" -s "$STACK"; then
                if [[ "${auto_approve:-false}" == "true" ]]; then
                  atmos terraform apply "$component" -s "$STACK" -auto-approve
                  log_success "$component deployed"
                else
                  log_info "$component plan generated. Set auto_approve=true to apply."
                fi
              fi
            done
          env:
            AWS_SDK_LOAD_CONFIG: 1

      - name: "bootstrap-summary"
        description: "Print bootstrap summary"
        run:
          command: |
            set -euo pipefail

            GREEN='\033[0;32m'
            WHITE='\033[1;37m'
            NC='\033[0m'

            echo -e "\n${WHITE}=== Bootstrap Summary ===${NC}\n"

            STACK="${tenant}-${account}-${environment}"
            REGION="${region:-eu-west-2}"

            echo "Stack: $STACK"
            echo "Region: $REGION"
            echo
            echo "Resources Created:"
            echo "  - S3 Bucket: ${tenant}-${account}-${environment}-terraform-state"
            echo "  - DynamoDB Table: ${tenant}-${account}-${environment}-terraform-locks"
            echo

            if [[ "${auto_approve:-false}" == "true" ]]; then
              echo -e "${GREEN}Bootstrap completed successfully!${NC}"
            else
              echo "Next Steps:"
              echo "  1. Review the generated plans"
              echo "  2. Re-run with auto_approve=true to apply changes:"
              echo "     atmos workflow bootstrap -f bootstrap.yaml tenant=${tenant} account=${account} environment=${environment} auto_approve=true"
            fi
          env:
            AWS_SDK_LOAD_CONFIG: 1

  # =============================================================================
  # Backend Only - Just creates backend infrastructure
  # =============================================================================
  backend-only:
    description: "Create only the Terraform backend (S3 + DynamoDB)"
    steps:
      - name: "create-backend"
        run:
          command: |
            set -euo pipefail

            GREEN='\033[0;32m'
            BLUE='\033[0;34m'
            WHITE='\033[1;37m'
            NC='\033[0m'

            echo -e "\n${WHITE}=== Create Backend Infrastructure ===${NC}\n"

            # Validate parameters
            if [[ -z "${tenant:-}" ]] || [[ -z "${account:-}" ]] || [[ -z "${environment:-}" ]]; then
              echo "ERROR: Missing parameters. Usage: tenant=<name> account=<name> environment=<name>"
              exit 1
            fi

            REGION="${region:-eu-west-2}"
            BUCKET_NAME="${tenant}-${account}-${environment}-terraform-state"
            DYNAMODB_TABLE="${tenant}-${account}-${environment}-terraform-locks"

            echo "Creating backend resources..."
            echo "  S3 Bucket:      $BUCKET_NAME"
            echo "  DynamoDB Table: $DYNAMODB_TABLE"
            echo "  Region:         $REGION"

            # Create S3 bucket
            if ! aws s3api head-bucket --bucket "$BUCKET_NAME" 2>/dev/null; then
              if [[ "$REGION" == "us-east-1" ]]; then
                aws s3api create-bucket --bucket "$BUCKET_NAME" --region "$REGION"
              else
                aws s3api create-bucket --bucket "$BUCKET_NAME" --region "$REGION" \
                  --create-bucket-configuration LocationConstraint="$REGION"
              fi

              aws s3api put-bucket-versioning --bucket "$BUCKET_NAME" --versioning-configuration Status=Enabled
              aws s3api put-bucket-encryption --bucket "$BUCKET_NAME" \
                --server-side-encryption-configuration '{"Rules":[{"ApplyServerSideEncryptionByDefault":{"SSEAlgorithm":"AES256"},"BucketKeyEnabled":true}]}'
              aws s3api put-public-access-block --bucket "$BUCKET_NAME" \
                --public-access-block-configuration '{"BlockPublicAcls":true,"IgnorePublicAcls":true,"BlockPublicPolicy":true,"RestrictPublicBuckets":true}'
              echo -e "${GREEN}S3 bucket created${NC}"
            else
              echo "S3 bucket already exists"
            fi

            # Create DynamoDB table
            if ! aws dynamodb describe-table --table-name "$DYNAMODB_TABLE" --region "$REGION" >/dev/null 2>&1; then
              aws dynamodb create-table \
                --table-name "$DYNAMODB_TABLE" \
                --attribute-definitions AttributeName=LockID,AttributeType=S \
                --key-schema AttributeName=LockID,KeyType=HASH \
                --billing-mode PAY_PER_REQUEST \
                --region "$REGION"
              aws dynamodb wait table-exists --table-name "$DYNAMODB_TABLE" --region "$REGION"
              aws dynamodb update-continuous-backups --table-name "$DYNAMODB_TABLE" --region "$REGION" \
                --point-in-time-recovery-specification PointInTimeRecoveryEnabled=true
              echo -e "${GREEN}DynamoDB table created${NC}"
            else
              echo "DynamoDB table already exists"
            fi

            echo -e "\n${GREEN}Backend infrastructure ready${NC}"
          env:
            AWS_SDK_LOAD_CONFIG: 1

  # =============================================================================
  # Verify Bootstrap - Check existing bootstrap resources
  # =============================================================================
  verify:
    description: "Verify bootstrap infrastructure exists and is properly configured"
    steps:
      - name: "verify-backend"
        run:
          command: |
            set -euo pipefail

            GREEN='\033[0;32m'
            RED='\033[0;31m'
            YELLOW='\033[1;33m'
            WHITE='\033[1;37m'
            NC='\033[0m'

            echo -e "\n${WHITE}=== Verify Bootstrap Infrastructure ===${NC}\n"

            if [[ -z "${tenant:-}" ]] || [[ -z "${account:-}" ]] || [[ -z "${environment:-}" ]]; then
              echo "ERROR: Missing parameters. Usage: tenant=<name> account=<name> environment=<name>"
              exit 1
            fi

            REGION="${region:-eu-west-2}"
            BUCKET_NAME="${tenant}-${account}-${environment}-terraform-state"
            DYNAMODB_TABLE="${tenant}-${account}-${environment}-terraform-locks"
            ERRORS=0

            echo "Checking backend resources..."

            # Check S3 bucket
            echo -n "  S3 Bucket ($BUCKET_NAME): "
            if aws s3api head-bucket --bucket "$BUCKET_NAME" 2>/dev/null; then
              echo -e "${GREEN}EXISTS${NC}"

              # Check versioning
              VERSIONING=$(aws s3api get-bucket-versioning --bucket "$BUCKET_NAME" --query 'Status' --output text 2>/dev/null || echo "None")
              if [[ "$VERSIONING" == "Enabled" ]]; then
                echo -e "    Versioning: ${GREEN}Enabled${NC}"
              else
                echo -e "    Versioning: ${YELLOW}$VERSIONING${NC}"
              fi

              # Check encryption
              if aws s3api get-bucket-encryption --bucket "$BUCKET_NAME" >/dev/null 2>&1; then
                echo -e "    Encryption: ${GREEN}Enabled${NC}"
              else
                echo -e "    Encryption: ${RED}Not configured${NC}"
                ((ERRORS++))
              fi

              # Check public access block
              if aws s3api get-public-access-block --bucket "$BUCKET_NAME" >/dev/null 2>&1; then
                echo -e "    Public Access Block: ${GREEN}Enabled${NC}"
              else
                echo -e "    Public Access Block: ${YELLOW}Not configured${NC}"
              fi
            else
              echo -e "${RED}NOT FOUND${NC}"
              ((ERRORS++))
            fi

            # Check DynamoDB table
            echo -n "  DynamoDB Table ($DYNAMODB_TABLE): "
            if aws dynamodb describe-table --table-name "$DYNAMODB_TABLE" --region "$REGION" >/dev/null 2>&1; then
              echo -e "${GREEN}EXISTS${NC}"

              # Check PITR
              PITR=$(aws dynamodb describe-continuous-backups --table-name "$DYNAMODB_TABLE" --region "$REGION" \
                --query 'ContinuousBackupsDescription.PointInTimeRecoveryDescription.PointInTimeRecoveryStatus' --output text 2>/dev/null || echo "UNKNOWN")
              if [[ "$PITR" == "ENABLED" ]]; then
                echo -e "    Point-in-Time Recovery: ${GREEN}Enabled${NC}"
              else
                echo -e "    Point-in-Time Recovery: ${YELLOW}$PITR${NC}"
              fi
            else
              echo -e "${RED}NOT FOUND${NC}"
              ((ERRORS++))
            fi

            echo
            if [[ $ERRORS -gt 0 ]]; then
              echo -e "${RED}Verification failed: $ERRORS error(s) found${NC}"
              exit 1
            else
              echo -e "${GREEN}All bootstrap resources verified successfully${NC}"
            fi
          env:
            AWS_SDK_LOAD_CONFIG: 1
