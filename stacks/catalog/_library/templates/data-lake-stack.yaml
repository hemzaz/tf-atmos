---
# Data Lake Stack Template
# Production-ready data lake infrastructure for analytics
# Version: 1.0.0

name: data-lake-stack
description: "Modern data lake architecture with S3, Glue, and Athena"
version: "1.0.0"
maturity: "stable"

template:
  category: "patterns/data-pipelines"
  use_cases:
    - "Enterprise data lake"
    - "Analytics platform"
    - "Data warehouse"
    - "Business intelligence"
    - "Machine learning data store"

  architecture:
    components:
      - name: "Ingestion"
        components: ["kinesis", "firehose", "dms"]
        description: "Real-time and batch data ingestion"
      - name: "Storage"
        components: ["s3", "lakeformation"]
        description: "Data lake storage with governance"
      - name: "Processing"
        components: ["glue", "emr", "step-functions"]
        description: "ETL and data processing"
      - name: "Query"
        components: ["athena", "redshift-spectrum"]
        description: "SQL analytics"
      - name: "Catalog"
        components: ["glue-catalog", "lakeformation"]
        description: "Data catalog and governance"

  estimated_cost:
    minimum: "$100/month"
    typical: "$500/month"
    maximum: "$5000+/month"

  deployment_time: "30-45 minutes"

# Stack configuration
import:
  - catalog/_base/defaults
  - catalog/iam/defaults

components:
  terraform:
    # ===========================================
    # STORAGE LAYER
    # ===========================================
    s3-raw:
      component: "s3"
      vars:
        enabled: true
        bucket_name: "${tenant}-${environment}-data-lake-raw"

        versioning_enabled: true
        sse_algorithm: "aws:kms"

        lifecycle_rules:
          - id: "transition-to-ia"
            enabled: true
            transitions:
              - days: 30
                storage_class: "STANDARD_IA"
              - days: 90
                storage_class: "GLACIER"

        block_public_access: true

        # Intelligent tiering for unpredictable access patterns
        intelligent_tiering:
          enabled: true
          archive_access_tier_days: 90
          deep_archive_access_tier_days: 180

      tags:
        StackType: "data-lake"
        Layer: "raw"
        DataClassification: "internal"

    s3-processed:
      component: "s3"
      vars:
        enabled: true
        bucket_name: "${tenant}-${environment}-data-lake-processed"

        versioning_enabled: true
        sse_algorithm: "aws:kms"

        lifecycle_rules:
          - id: "transition-to-ia"
            enabled: true
            transitions:
              - days: 90
                storage_class: "STANDARD_IA"

        block_public_access: true

      tags:
        StackType: "data-lake"
        Layer: "processed"

    s3-curated:
      component: "s3"
      vars:
        enabled: true
        bucket_name: "${tenant}-${environment}-data-lake-curated"

        versioning_enabled: true
        sse_algorithm: "aws:kms"
        block_public_access: true

        # Analytics optimized
        analytics_configuration:
          - id: "analytics"
            storage_class_analysis:
              data_export:
                destination:
                  s3_bucket_destination:
                    bucket_arn: "${output.s3-raw.bucket_arn}"
                    prefix: "analytics/"

      tags:
        StackType: "data-lake"
        Layer: "curated"

    # ===========================================
    # INGESTION LAYER
    # ===========================================
    kinesis-stream:
      component: "kinesis"
      vars:
        enabled: true
        stream_name: "${tenant}-${environment}-data-stream"

        shard_count: 2
        retention_period: 168  # 7 days

        # Enhanced fan-out for high throughput consumers
        enable_enhanced_fanout: true

        # Encryption
        encryption_type: "KMS"

        stream_mode: "ON_DEMAND"  # Auto-scaling

      tags:
        StackType: "data-lake"
        Layer: "ingestion"

    firehose:
      component: "firehose"
      depends_on:
        - s3-raw
        - kinesis-stream
      vars:
        enabled: true
        delivery_stream_name: "${tenant}-${environment}-firehose"

        # Source from Kinesis
        kinesis_source_configuration:
          kinesis_stream_arn: "${output.kinesis-stream.stream_arn}"

        # S3 destination
        s3_configuration:
          bucket_arn: "${output.s3-raw.bucket_arn}"
          prefix: "firehose/year=!{timestamp:yyyy}/month=!{timestamp:MM}/day=!{timestamp:dd}/hour=!{timestamp:HH}/"
          error_output_prefix: "firehose-errors/!{firehose:error-output-type}/year=!{timestamp:yyyy}/month=!{timestamp:MM}/day=!{timestamp:dd}/"
          buffering_size: 128  # MB
          buffering_interval: 60  # seconds
          compression_format: "GZIP"

        # Data format conversion
        data_format_conversion:
          enabled: true
          input_format_configuration:
            deserializer: "JSON"
          output_format_configuration:
            serializer: "PARQUET"
          schema_configuration:
            database_name: "${output.glue-database.database_name}"
            table_name: "raw_events"

      tags:
        StackType: "data-lake"
        Layer: "ingestion"

    # ===========================================
    # CATALOG AND GOVERNANCE
    # ===========================================
    glue-database:
      component: "glue"
      vars:
        enabled: true
        database_name: "${tenant}_${environment}_data_lake"
        description: "Data lake database for ${tenant} ${environment}"

        catalog_id: "${aws_account_id}"

        # Create location
        location_uri: "s3://${output.s3-curated.bucket_name}/"

      tags:
        StackType: "data-lake"
        Layer: "catalog"

    glue-crawler:
      component: "glue-crawler"
      depends_on:
        - glue-database
        - s3-raw
        - s3-processed
        - s3-curated
      vars:
        enabled: true

        crawlers:
          raw-crawler:
            name: "${tenant}-${environment}-raw-crawler"
            database_name: "${output.glue-database.database_name}"
            description: "Crawl raw data zone"
            schedule: "cron(0 */6 * * ? *)"  # Every 6 hours
            s3_targets:
              - path: "s3://${output.s3-raw.bucket_name}/firehose/"
                exclusions:
                  - "**/_temporary/**"
            schema_change_policy:
              delete_behavior: "LOG"
              update_behavior: "UPDATE_IN_DATABASE"

          processed-crawler:
            name: "${tenant}-${environment}-processed-crawler"
            database_name: "${output.glue-database.database_name}"
            description: "Crawl processed data zone"
            schedule: "cron(0 */6 * * ? *)"
            s3_targets:
              - path: "s3://${output.s3-processed.bucket_name}/"

          curated-crawler:
            name: "${tenant}-${environment}-curated-crawler"
            database_name: "${output.glue-database.database_name}"
            description: "Crawl curated data zone"
            schedule: "cron(0 */6 * * ? *)"
            s3_targets:
              - path: "s3://${output.s3-curated.bucket_name}/"

      tags:
        StackType: "data-lake"
        Layer: "catalog"

    lakeformation:
      component: "lakeformation"
      depends_on:
        - glue-database
        - s3-raw
        - s3-processed
        - s3-curated
      vars:
        enabled: true

        # Data lake settings
        data_lake_settings:
          admins:
            - "${aws_account_id}"

        # Register data lake locations
        resources:
          - resource_arn: "${output.s3-raw.bucket_arn}"
            use_service_linked_role: true
          - resource_arn: "${output.s3-processed.bucket_arn}"
            use_service_linked_role: true
          - resource_arn: "${output.s3-curated.bucket_arn}"
            use_service_linked_role: true

        # Permissions
        permissions:
          - principal: "${output.iam.data_engineer_role_arn}"
            database_name: "${output.glue-database.database_name}"
            permissions:
              - "ALL"
          - principal: "${output.iam.data_analyst_role_arn}"
            database_name: "${output.glue-database.database_name}"
            permissions:
              - "SELECT"
              - "DESCRIBE"

      tags:
        StackType: "data-lake"
        Layer: "governance"

    # ===========================================
    # PROCESSING LAYER
    # ===========================================
    glue-etl:
      component: "glue-job"
      depends_on:
        - glue-database
        - s3-raw
        - s3-processed
      vars:
        enabled: true

        jobs:
          raw-to-processed:
            name: "${tenant}-${environment}-raw-to-processed"
            description: "ETL job: Raw to Processed zone"
            role_arn: "${output.iam.glue_role_arn}"
            glue_version: "4.0"
            worker_type: "G.1X"
            number_of_workers: 2
            timeout: 60  # minutes

            command:
              name: "glueetl"
              python_version: "3"
              script_location: "s3://${output.s3-scripts.bucket_name}/glue/raw_to_processed.py"

            default_arguments:
              "--enable-metrics": "true"
              "--enable-spark-ui": "true"
              "--enable-continuous-cloudwatch-log": "true"
              "--source-path": "s3://${output.s3-raw.bucket_name}/"
              "--target-path": "s3://${output.s3-processed.bucket_name}/"
              "--database-name": "${output.glue-database.database_name}"

          processed-to-curated:
            name: "${tenant}-${environment}-processed-to-curated"
            description: "ETL job: Processed to Curated zone"
            role_arn: "${output.iam.glue_role_arn}"
            glue_version: "4.0"
            worker_type: "G.1X"
            number_of_workers: 4
            timeout: 120

            command:
              name: "glueetl"
              python_version: "3"
              script_location: "s3://${output.s3-scripts.bucket_name}/glue/processed_to_curated.py"

            default_arguments:
              "--enable-metrics": "true"
              "--enable-spark-ui": "true"
              "--enable-continuous-cloudwatch-log": "true"
              "--source-path": "s3://${output.s3-processed.bucket_name}/"
              "--target-path": "s3://${output.s3-curated.bucket_name}/"
              "--database-name": "${output.glue-database.database_name}"

      tags:
        StackType: "data-lake"
        Layer: "processing"

    # ===========================================
    # QUERY LAYER
    # ===========================================
    athena:
      component: "athena"
      depends_on:
        - glue-database
      vars:
        enabled: true
        workgroup_name: "${tenant}-${environment}-analytics"

        # Query results location
        output_location: "s3://${output.s3-curated.bucket_name}/athena-results/"

        # Workgroup configuration
        enforce_workgroup_configuration: true
        publish_cloudwatch_metrics_enabled: true

        # Query limits
        bytes_scanned_cutoff_per_query: 10737418240  # 10 GB

        # Named queries
        named_queries:
          - name: "daily-summary"
            description: "Daily summary statistics"
            database: "${output.glue-database.database_name}"
            query: |
              SELECT
                date_trunc('day', event_time) as event_date,
                count(*) as event_count
              FROM events
              WHERE event_time >= current_date - interval '7' day
              GROUP BY 1
              ORDER BY 1 DESC

      tags:
        StackType: "data-lake"
        Layer: "query"

    # ===========================================
    # IAM
    # ===========================================
    iam:
      component: "iam"
      vars:
        enabled: true

        roles:
          # Glue service role
          glue-role:
            name: "${tenant}-${environment}-glue-role"
            assume_role_policy:
              Version: "2012-10-17"
              Statement:
                - Effect: "Allow"
                  Principal:
                    Service: "glue.amazonaws.com"
                  Action: "sts:AssumeRole"
            managed_policy_arns:
              - "arn:aws:iam::aws:policy/service-role/AWSGlueServiceRole"
            inline_policies:
              s3-access:
                - Effect: "Allow"
                  Action:
                    - "s3:GetObject"
                    - "s3:PutObject"
                    - "s3:DeleteObject"
                    - "s3:ListBucket"
                  Resource:
                    - "${output.s3-raw.bucket_arn}"
                    - "${output.s3-raw.bucket_arn}/*"
                    - "${output.s3-processed.bucket_arn}"
                    - "${output.s3-processed.bucket_arn}/*"
                    - "${output.s3-curated.bucket_arn}"
                    - "${output.s3-curated.bucket_arn}/*"

          # Data engineer role
          data-engineer-role:
            name: "${tenant}-${environment}-data-engineer"
            assume_role_policy:
              Version: "2012-10-17"
              Statement:
                - Effect: "Allow"
                  Principal:
                    AWS: "arn:aws:iam::${aws_account_id}:root"
                  Action: "sts:AssumeRole"
            managed_policy_arns:
              - "arn:aws:iam::aws:policy/AmazonAthenaFullAccess"

          # Data analyst role (read-only)
          data-analyst-role:
            name: "${tenant}-${environment}-data-analyst"
            assume_role_policy:
              Version: "2012-10-17"
              Statement:
                - Effect: "Allow"
                  Principal:
                    AWS: "arn:aws:iam::${aws_account_id}:root"
                  Action: "sts:AssumeRole"
            managed_policy_arns:
              - "arn:aws:iam::aws:policy/AmazonAthenaReadOnlyAccess"

      tags:
        StackType: "data-lake"
        Layer: "security"

    # ===========================================
    # OBSERVABILITY
    # ===========================================
    monitoring:
      component: "monitoring"
      vars:
        enabled: true

        create_dashboard: true
        dashboard_name: "${tenant}-${environment}-data-lake"

        alarm_notifications_enabled: true
        sns_topic_name: "${tenant}-${environment}-data-lake-alarms"

        alarms:
          kinesis-iterator-age:
            metric_name: "GetRecords.IteratorAgeMilliseconds"
            namespace: "AWS/Kinesis"
            statistic: "Maximum"
            period: 300
            evaluation_periods: 3
            threshold: 60000  # 1 minute
            comparison_operator: "GreaterThanThreshold"

          glue-job-failures:
            metric_name: "glue.driver.aggregate.numFailedTasks"
            namespace: "Glue"
            statistic: "Sum"
            period: 300
            evaluation_periods: 1
            threshold: 0
            comparison_operator: "GreaterThanThreshold"

          athena-query-failures:
            metric_name: "QueryFailure"
            namespace: "AWS/Athena"
            statistic: "Sum"
            period: 300
            evaluation_periods: 3
            threshold: 5
            comparison_operator: "GreaterThanThreshold"

      tags:
        StackType: "data-lake"
        Layer: "observability"

# Deployment order
deployment_order:
  - stage: 1
    components: [iam]
  - stage: 2
    components: [s3-raw, s3-processed, s3-curated]
    parallel: true
  - stage: 3
    components: [kinesis-stream, glue-database]
    parallel: true
  - stage: 4
    components: [firehose, glue-crawler, lakeformation]
    parallel: true
  - stage: 5
    components: [glue-etl, athena]
    parallel: true
  - stage: 6
    components: [monitoring]
