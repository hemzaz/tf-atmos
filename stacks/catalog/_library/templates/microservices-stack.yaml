---
# Microservices Platform Stack Template
# Production-ready microservices infrastructure on Kubernetes
# Version: 1.0.0

name: microservices-stack
description: "Enterprise microservices platform with service mesh and observability"
version: "1.0.0"
maturity: "production"

template:
  category: "patterns/microservices"
  use_cases:
    - "Microservices architectures"
    - "Event-driven systems"
    - "API-first platforms"
    - "Domain-driven design implementations"

  architecture:
    components:
      - name: "Service Mesh"
        components: ["istio", "envoy"]
        description: "Service discovery, load balancing, and mTLS"
      - name: "Container Platform"
        components: ["eks", "eks-addons"]
        description: "Kubernetes orchestration"
      - name: "API Gateway"
        components: ["apigateway", "kong"]
        description: "API management and routing"
      - name: "Observability"
        components: ["prometheus", "grafana", "jaeger"]
        description: "Metrics, logging, and tracing"
      - name: "Event Bus"
        components: ["sns", "sqs", "eventbridge"]
        description: "Asynchronous communication"

  estimated_cost:
    minimum: "$500/month"
    typical: "$1500/month"
    maximum: "$5000+/month"

  deployment_time: "60-90 minutes"

# Stack configuration
import:
  - catalog/_base/defaults
  - catalog/vpc/defaults
  - catalog/securitygroup/defaults
  - catalog/eks/defaults
  - catalog/monitoring/defaults

components:
  terraform:
    # ===========================================
    # NETWORK LAYER
    # ===========================================
    vpc:
      component: "vpc"
      vars:
        enabled: true
        name: "microservices"
        vpc_cidr: "10.0.0.0/16"

        # Multi-AZ for high availability
        azs:
          - "${region}a"
          - "${region}b"
          - "${region}c"

        # Expanded subnet space for microservices
        private_subnets:
          - "10.0.0.0/20"    # 4096 IPs
          - "10.0.16.0/20"   # 4096 IPs
          - "10.0.32.0/20"   # 4096 IPs
        public_subnets:
          - "10.0.100.0/24"
          - "10.0.101.0/24"
          - "10.0.102.0/24"
        database_subnets:
          - "10.0.200.0/24"
          - "10.0.201.0/24"
          - "10.0.202.0/24"

        # NAT Gateway - HA configuration
        enable_nat_gateway: true
        nat_gateway_strategy: "one_per_az"

        # VPC Endpoints for AWS services
        enable_vpc_endpoints: true
        vpc_endpoints:
          - "s3"
          - "ecr.api"
          - "ecr.dkr"
          - "logs"
          - "sts"
          - "ssm"
          - "secretsmanager"

        # VPC Flow Logs
        vpc_flow_logs_enabled: true
        vpc_flow_logs_traffic_type: "ALL"

      tags:
        StackType: "microservices"
        Layer: "network"

    # ===========================================
    # SECURITY LAYER
    # ===========================================
    securitygroup:
      component: "securitygroup"
      depends_on:
        - vpc
      vars:
        enabled: true
        vpc_id: "${output.vpc.vpc_id}"

        security_groups:
          # Cluster Security Group
          eks-cluster-sg:
            name: "${tenant}-${environment}-eks-cluster-sg"
            description: "EKS cluster security group"
            ingress_rules:
              - from_port: 443
                to_port: 443
                protocol: "tcp"
                cidr_blocks: ["${output.vpc.vpc_cidr_block}"]
                description: "API server from VPC"
            egress_rules:
              - from_port: 0
                to_port: 0
                protocol: "-1"
                cidr_blocks: ["0.0.0.0/0"]

          # Node Security Group
          eks-node-sg:
            name: "${tenant}-${environment}-eks-node-sg"
            description: "EKS worker nodes security group"
            ingress_rules:
              - from_port: 0
                to_port: 65535
                protocol: "tcp"
                self: true
                description: "Node to node communication"
              - from_port: 443
                to_port: 443
                protocol: "tcp"
                source_security_group_id: "${security_group.eks-cluster-sg.id}"
                description: "API server to nodes"
              - from_port: 10250
                to_port: 10250
                protocol: "tcp"
                source_security_group_id: "${security_group.eks-cluster-sg.id}"
                description: "Kubelet from API server"
            egress_rules:
              - from_port: 0
                to_port: 0
                protocol: "-1"
                cidr_blocks: ["0.0.0.0/0"]

          # Service Mesh (Istio) Security Group
          istio-sg:
            name: "${tenant}-${environment}-istio-sg"
            description: "Istio service mesh security group"
            ingress_rules:
              - from_port: 15000
                to_port: 15100
                protocol: "tcp"
                self: true
                description: "Envoy admin and proxy ports"
              - from_port: 15443
                to_port: 15443
                protocol: "tcp"
                cidr_blocks: ["${output.vpc.vpc_cidr_block}"]
                description: "Istio mTLS"
            egress_rules:
              - from_port: 0
                to_port: 0
                protocol: "-1"
                cidr_blocks: ["0.0.0.0/0"]

      tags:
        StackType: "microservices"
        Layer: "security"

    # ===========================================
    # CONTAINER PLATFORM
    # ===========================================
    eks:
      component: "eks"
      depends_on:
        - vpc
        - securitygroup
        - iam
      vars:
        enabled: true
        cluster_name: "${tenant}-${environment}-microservices"
        kubernetes_version: "1.28"

        # Network configuration
        vpc_id: "${output.vpc.vpc_id}"
        subnet_ids: "${output.vpc.private_subnet_ids}"

        # Endpoint access - private only for security
        endpoint_private_access: true
        endpoint_public_access: false

        # Security
        encrypt_secrets: true
        enable_cluster_logging: true
        enabled_cluster_log_types:
          - "api"
          - "audit"
          - "authenticator"
          - "controllerManager"
          - "scheduler"

        # Node groups optimized for microservices
        node_groups:
          # System workloads
          system:
            name: "system"
            instance_types: ["m5.large"]
            desired_size: 3
            min_size: 2
            max_size: 5
            disk_size: 50
            capacity_type: "ON_DEMAND"
            labels:
              workload-type: "system"
              node-role: "system"
            taints:
              - key: "CriticalAddonsOnly"
                value: "true"
                effect: "NO_SCHEDULE"

          # Application workloads - general purpose
          application:
            name: "application"
            instance_types: ["m5.xlarge", "m5.2xlarge"]
            desired_size: 5
            min_size: 3
            max_size: 50
            disk_size: 100
            capacity_type: "ON_DEMAND"
            labels:
              workload-type: "application"
              node-role: "application"

          # Spot instances for non-critical workloads
          spot:
            name: "spot"
            instance_types: ["m5.xlarge", "m5.2xlarge", "m4.xlarge"]
            desired_size: 3
            min_size: 0
            max_size: 30
            disk_size: 100
            capacity_type: "SPOT"
            labels:
              workload-type: "batch"
              node-role: "spot"
            taints:
              - key: "spot"
                value: "true"
                effect: "NO_SCHEDULE"

          # High-memory workloads
          memory-optimized:
            name: "memory-optimized"
            instance_types: ["r5.xlarge", "r5.2xlarge"]
            desired_size: 2
            min_size: 0
            max_size: 10
            disk_size: 100
            capacity_type: "ON_DEMAND"
            labels:
              workload-type: "memory-intensive"
              node-role: "memory"

      tags:
        StackType: "microservices"
        Layer: "compute"

    eks-addons:
      component: "eks-addons"
      depends_on:
        - eks
      vars:
        enabled: true
        cluster_name: "${output.eks.cluster_id}"

        # Core addons
        enable_metrics_server: true
        enable_cluster_autoscaler: true
        enable_aws_load_balancer_controller: true
        enable_external_dns: true
        enable_cert_manager: true
        enable_external_secrets: true

        # Service mesh configuration
        enable_istio: true
        istio_config:
          version: "1.20"
          profile: "default"
          components:
            ingressGateway: true
            egressGateway: true

        # Observability stack
        enable_prometheus: true
        prometheus_config:
          retention: "15d"
          storage_size: "100Gi"

        enable_grafana: true
        grafana_config:
          admin_password: "${secretsmanager.grafana_admin_password}"
          persistence_enabled: true
          persistence_size: "10Gi"

        enable_jaeger: true
        jaeger_config:
          strategy: "production"
          elasticsearch_enabled: true

        # Logging
        enable_fluent_bit: true
        fluent_bit_config:
          output: "cloudwatch"
          log_group: "/aws/eks/${tenant}-${environment}-microservices/containers"

      tags:
        StackType: "microservices"
        Layer: "compute"

    # ===========================================
    # API GATEWAY
    # ===========================================
    apigateway:
      component: "apigateway"
      depends_on:
        - vpc
        - eks
      vars:
        enabled: true
        api_name: "${tenant}-${environment}-microservices-api"
        api_type: "HTTP"
        endpoint_type: ["REGIONAL"]

        # CORS configuration
        cors_configuration:
          allow_origins: ["*"]
          allow_methods: ["GET", "POST", "PUT", "DELETE", "OPTIONS"]
          allow_headers: ["Content-Type", "Authorization", "X-Request-ID"]
          max_age: 7200

        # VPC Link for private integration
        create_vpc_link: true
        vpc_link_name: "${tenant}-${environment}-vpc-link"
        vpc_link_security_group_ids:
          - "${output.securitygroup.security_group_ids['eks-node-sg']}"
        vpc_link_subnet_ids: "${output.vpc.private_subnet_ids}"

        # Logging
        enable_logging: true
        log_retention_days: 30

        # Throttling
        default_route_settings:
          throttling_burst_limit: 5000
          throttling_rate_limit: 10000

      tags:
        StackType: "microservices"
        Layer: "api"

    # ===========================================
    # MESSAGE BUS
    # ===========================================
    eventbus:
      component: "eventbridge"
      vars:
        enabled: true
        event_bus_name: "${tenant}-${environment}-microservices-bus"

        # Event archive
        create_archive: true
        archive_retention_days: 30

        # Dead letter queue
        create_dlq: true

      tags:
        StackType: "microservices"
        Layer: "messaging"

    # ===========================================
    # SECRETS MANAGEMENT
    # ===========================================
    secretsmanager:
      component: "secretsmanager"
      vars:
        enabled: true
        context_name: "microservices"

        secrets:
          grafana_admin_password:
            name: "grafana-admin"
            description: "Grafana admin password"
            generate_random_password: true

          db_credentials:
            name: "database-credentials"
            description: "Database connection credentials"
            generate_random_password: true

      tags:
        StackType: "microservices"
        Layer: "security"

    external-secrets:
      component: "external-secrets"
      depends_on:
        - eks
        - secretsmanager
      vars:
        enabled: true
        cluster_name: "${output.eks.cluster_id}"

        # Secret stores
        secret_stores:
          default:
            create: true
            provider: "aws"
            service: "SecretsManager"

      tags:
        StackType: "microservices"
        Layer: "security"

    # ===========================================
    # OBSERVABILITY
    # ===========================================
    monitoring:
      component: "monitoring"
      depends_on:
        - vpc
        - eks
      vars:
        enabled: true

        # Dashboard
        create_dashboard: true
        dashboard_name: "${tenant}-${environment}-microservices"

        # Alarms
        alarm_notifications_enabled: true
        sns_topic_name: "${tenant}-${environment}-microservices-alarms"

        # EKS monitoring
        eks_cluster_name: "${output.eks.cluster_id}"

        # Service mesh metrics
        enable_istio_metrics: true

        # Custom metrics for microservices
        custom_metrics:
          - namespace: "Microservices"
            metric_name: "RequestCount"
            dimensions:
              - name: "Service"
              - name: "Method"
          - namespace: "Microservices"
            metric_name: "ErrorRate"
            dimensions:
              - name: "Service"
          - namespace: "Microservices"
            metric_name: "Latency"
            dimensions:
              - name: "Service"
              - name: "Percentile"

        # Composite alarms
        composite_alarms:
          service_health:
            name: "service-health"
            alarm_rule: "ALARM(cpu-high) OR ALARM(memory-high) OR ALARM(error-rate-high)"

      tags:
        StackType: "microservices"
        Layer: "observability"

# Deployment order
deployment_order:
  - stage: 1
    components: [vpc, vpc-flow-logs-bucket]
    parallel: true
  - stage: 2
    components: [iam, securitygroup, secretsmanager]
    parallel: true
  - stage: 3
    components: [eks]
    parallel: false
  - stage: 4
    components: [eks-addons, external-secrets, apigateway]
    parallel: true
  - stage: 5
    components: [eventbus, monitoring]
    parallel: true

# Validation rules
validation:
  pre_deployment:
    - check: "vpc_cidr_available"
    - check: "eks_version_supported"
    - check: "service_quotas_sufficient"
  post_deployment:
    - check: "eks_cluster_healthy"
    - check: "istio_installed"
    - check: "observability_stack_running"
