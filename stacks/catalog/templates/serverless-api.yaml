---
# =============================================================================
# SERVERLESS API STACK TEMPLATE
# =============================================================================
# Complete serverless API platform infrastructure
#
# Architecture:
#   - API Gateway (REST or HTTP)
#   - Lambda functions for API handlers
#   - DynamoDB tables for data storage
#   - Cognito for user authentication
#   - S3 for static assets and uploads
#   - CloudFront for CDN
#   - WAF for API protection
#   - CloudWatch for monitoring and logging
#
# Cost Estimates (Monthly):
#   Development:  ~$10-50/month (minimal traffic)
#   Staging:      ~$50-200/month
#   Production:   ~$200-2,000/month (scales with usage)
#
# Key Benefits:
#   - Zero infrastructure to manage
#   - Pay-per-use pricing
#   - Auto-scaling by default
#   - High availability built-in
#
# Deployment Time: 15-25 minutes
#
# Usage:
#   atmos terraform plan serverless-api -s <tenant>-<account>-<environment>
#   atmos terraform apply serverless-api -s <tenant>-<account>-<environment>
# =============================================================================

name: serverless-api
description: "Complete serverless API platform with Lambda, API Gateway, DynamoDB, and Cognito"
version: "1.0.0"

# Import base configurations
import:
  - catalog/_base/defaults
  - catalog/iam/defaults
  - catalog/acm/defaults
  - catalog/monitoring/defaults

# =============================================================================
# COMPONENT DEFINITIONS
# =============================================================================

components:
  terraform:
    # =========================================================================
    # AUTHENTICATION (Cognito)
    # =========================================================================

    serverless-api/cognito:
      metadata:
        component: cognito
        type: real
      vars:
        user_pool_name: "${tenant}-${environment}-api-users"
        description: "User pool for serverless API authentication"

        # Password policy
        password_policy:
          minimum_length: 12
          require_lowercase: true
          require_uppercase: true
          require_numbers: true
          require_symbols: true
          temporary_password_validity_days: 7

        # MFA configuration
        mfa_configuration: "${mfa_configuration | default('OPTIONAL')}"
        software_token_mfa_configuration:
          enabled: true

        # Account recovery
        account_recovery_setting:
          recovery_mechanisms:
            - name: "verified_email"
              priority: 1
            - name: "verified_phone_number"
              priority: 2

        # User attributes
        schema:
          - name: "email"
            attribute_data_type: "String"
            required: true
            mutable: true
            string_attribute_constraints:
              min_length: 5
              max_length: 256
          - name: "name"
            attribute_data_type: "String"
            required: false
            mutable: true
            string_attribute_constraints:
              min_length: 1
              max_length: 256
          - name: "custom:tenant_id"
            attribute_data_type: "String"
            required: false
            mutable: true
            string_attribute_constraints:
              min_length: 1
              max_length: 128

        # Auto-verified attributes
        auto_verified_attributes:
          - "email"

        # Email configuration
        email_configuration:
          email_sending_account: "${email_sending_account | default('COGNITO_DEFAULT')}"
          source_arn: "${ses_source_arn}"
          from_email_address: "${from_email_address}"
          reply_to_email_address: "${reply_to_email_address}"

        # User pool domain
        domain: "${tenant}-${environment}-api"
        domain_certificate_arn: "${cognito_domain_certificate_arn}"

        # App clients
        clients:
          web:
            name: "${tenant}-${environment}-web-client"
            generate_secret: false
            allowed_oauth_flows:
              - "code"
              - "implicit"
            allowed_oauth_flows_user_pool_client: true
            allowed_oauth_scopes:
              - "email"
              - "openid"
              - "profile"
              - "aws.cognito.signin.user.admin"
            callback_urls: "${web_callback_urls | default(['http://localhost:3000/callback'])}"
            logout_urls: "${web_logout_urls | default(['http://localhost:3000/logout'])}"
            supported_identity_providers:
              - "COGNITO"
            explicit_auth_flows:
              - "ALLOW_USER_SRP_AUTH"
              - "ALLOW_REFRESH_TOKEN_AUTH"
            prevent_user_existence_errors: "ENABLED"
            id_token_validity: 60
            access_token_validity: 60
            refresh_token_validity: 30
            token_validity_units:
              id_token: "minutes"
              access_token: "minutes"
              refresh_token: "days"

          mobile:
            name: "${tenant}-${environment}-mobile-client"
            generate_secret: true
            allowed_oauth_flows:
              - "code"
            allowed_oauth_flows_user_pool_client: true
            allowed_oauth_scopes:
              - "email"
              - "openid"
              - "profile"
            callback_urls: "${mobile_callback_urls | default(['myapp://callback'])}"
            logout_urls: "${mobile_logout_urls | default(['myapp://logout'])}"
            supported_identity_providers:
              - "COGNITO"
            explicit_auth_flows:
              - "ALLOW_USER_SRP_AUTH"
              - "ALLOW_REFRESH_TOKEN_AUTH"
            prevent_user_existence_errors: "ENABLED"

          api:
            name: "${tenant}-${environment}-api-client"
            generate_secret: true
            allowed_oauth_flows:
              - "client_credentials"
            allowed_oauth_flows_user_pool_client: true
            allowed_oauth_scopes:
              - "${tenant}-${environment}-api/read"
              - "${tenant}-${environment}-api/write"

        # Resource server (for API scopes)
        resource_servers:
          api:
            identifier: "${tenant}-${environment}-api"
            name: "API Resource Server"
            scopes:
              - scope_name: "read"
                scope_description: "Read access to API"
              - scope_name: "write"
                scope_description: "Write access to API"

        # Lambda triggers
        lambda_config:
          pre_sign_up: "${pre_signup_lambda_arn}"
          post_confirmation: "${post_confirmation_lambda_arn}"
          pre_token_generation: "${pre_token_generation_lambda_arn}"
          custom_message: "${custom_message_lambda_arn}"

        # Advanced security
        user_pool_add_ons:
          advanced_security_mode: "${advanced_security_mode | default('AUDIT')}"

        # Deletion protection
        deletion_protection: "${cognito_deletion_protection | default('INACTIVE')}"

      tags:
        Layer: "authentication"
        Service: "cognito"

    # =========================================================================
    # API GATEWAY
    # =========================================================================

    serverless-api/apigateway:
      metadata:
        component: apigateway
        type: real
      depends_on:
        - serverless-api/cognito
      vars:
        api_name: "${tenant}-${environment}-serverless-api"
        description: "Serverless REST API"
        api_type: "${api_type | default('REST')}"

        # Endpoint configuration
        endpoint_type:
          - "${endpoint_type | default('REGIONAL')}"

        # REST API specific configurations
        binary_media_types:
          - "application/octet-stream"
          - "image/*"
          - "multipart/form-data"
        minimum_compression_size: 10240

        # CORS configuration (for HTTP API)
        cors_configuration:
          allow_origins:
            - "https://${app_domain_name}"
            - "https://www.${app_domain_name}"
          allow_methods:
            - "GET"
            - "POST"
            - "PUT"
            - "DELETE"
            - "PATCH"
            - "OPTIONS"
          allow_headers:
            - "Content-Type"
            - "Authorization"
            - "X-Api-Key"
            - "X-Amz-Date"
            - "X-Amz-Security-Token"
          expose_headers:
            - "X-Request-Id"
          max_age: 300
          allow_credentials: true

        # Cognito authorizer
        authorizers:
          cognito:
            name: "cognito-authorizer"
            type: "COGNITO_USER_POOLS"
            provider_arns:
              - "${output.serverless-api/cognito.user_pool_arn}"
            identity_source: "method.request.header.Authorization"

        # Logging
        enable_logging: true
        log_format: '{ "requestId":"$context.requestId", "ip": "$context.identity.sourceIp", "caller":"$context.identity.caller", "user":"$context.identity.user", "requestTime":"$context.requestTime", "httpMethod":"$context.httpMethod", "resourcePath":"$context.resourcePath", "status":"$context.status", "protocol":"$context.protocol", "responseLength":"$context.responseLength", "integrationError":"$context.integrationErrorMessage", "integrationLatency":"$context.integrationLatency" }'
        log_retention_days: "${log_retention_days | default(30)}"

        # Stage configuration
        stage_name: "${environment}"
        auto_deploy: "${api_auto_deploy | default(true)}"

        # Stage variables
        stage_variables:
          environment: "${environment}"
          log_level: "${api_log_level | default('INFO')}"

        # Throttling (account-level defaults)
        throttle_settings:
          burst_limit: "${api_burst_limit | default(5000)}"
          rate_limit: "${api_rate_limit | default(10000)}"

        # API keys and usage plans
        create_api_key: "${create_api_key | default(false)}"
        usage_plans:
          basic:
            name: "${tenant}-${environment}-basic-plan"
            description: "Basic usage plan"
            throttle:
              burst_limit: 100
              rate_limit: 50
            quota:
              limit: 10000
              period: "MONTH"
          premium:
            name: "${tenant}-${environment}-premium-plan"
            description: "Premium usage plan"
            throttle:
              burst_limit: 500
              rate_limit: 200
            quota:
              limit: 100000
              period: "MONTH"

        # X-Ray tracing
        tracing_enabled: true

        # Request validation
        request_validators:
          all:
            name: "validate-all"
            validate_request_body: true
            validate_request_parameters: true
          body_only:
            name: "validate-body-only"
            validate_request_body: true
            validate_request_parameters: false

      tags:
        Layer: "api"
        Service: "api-gateway"

    # =========================================================================
    # API CUSTOM DOMAIN
    # =========================================================================

    serverless-api/api-domain:
      metadata:
        component: apigateway-domain
        type: real
      depends_on:
        - serverless-api/apigateway
        - serverless-api/acm
      vars:
        domain_name: "api.${app_domain_name}"
        certificate_arn: "${output.serverless-api/acm.certificate_arns.api}"

        # Base path mapping
        base_path_mappings:
          - api_id: "${output.serverless-api/apigateway.api_id}"
            stage_name: "${environment}"
            base_path: "${api_base_path | default('')}"

        # Security policy
        security_policy: "TLS_1_2"

        # Endpoint configuration
        endpoint_configuration:
          types:
            - "${endpoint_type | default('REGIONAL')}"

        # Route53 record
        create_route53_record: true
        zone_id: "${route53_zone_id}"

      tags:
        Layer: "api"
        Service: "custom-domain"

    # =========================================================================
    # SSL/TLS CERTIFICATES
    # =========================================================================

    serverless-api/acm:
      metadata:
        component: acm
        type: real
        inherits:
          - acm/defaults
      vars:
        dns_domains:
          api:
            domain_name: "api.${app_domain_name}"
            validation_method: "DNS"
          assets:
            domain_name: "assets.${app_domain_name}"
            validation_method: "DNS"
        zone_id: "${route53_zone_id}"

      tags:
        Layer: "security"
        Service: "certificates"

    # =========================================================================
    # LAMBDA FUNCTIONS
    # =========================================================================

    serverless-api/lambda-api-handler:
      metadata:
        component: lambda
        type: real
      depends_on:
        - serverless-api/dynamodb
      vars:
        function_name: "api-handler"
        description: "Main API handler function"

        # Runtime configuration
        runtime: "${lambda_runtime | default('python3.11')}"
        handler: "app.handler"
        timeout: "${api_lambda_timeout | default(30)}"
        memory_size: "${api_lambda_memory | default(512)}"

        # Architecture
        architectures:
          - "${lambda_architecture | default('arm64')}"

        # Reserved concurrency
        reserved_concurrent_executions: "${api_lambda_concurrency | default(100)}"

        # Environment variables
        environment_variables:
          ENVIRONMENT: "${environment}"
          TABLE_NAME: "${output.serverless-api/dynamodb.table_names.main}"
          USER_POOL_ID: "${output.serverless-api/cognito.user_pool_id}"
          LOG_LEVEL: "${log_level | default('INFO')}"
          POWERTOOLS_SERVICE_NAME: "${tenant}-${environment}-api"
          POWERTOOLS_METRICS_NAMESPACE: "${tenant}/${environment}/api"

        # Layers (AWS Lambda Powertools, etc.)
        layers:
          - "${lambda_powertools_layer_arn}"

        # X-Ray tracing
        tracing_mode: "Active"

        # CloudWatch logs
        log_retention_days: "${log_retention_days | default(30)}"
        kms_key_id: "${lambda_logs_kms_key_id}"

        # VPC configuration (optional - for database access)
        vpc_id: "${vpc_id}"
        subnet_ids: "${private_subnet_ids}"

        # IAM permissions
        policy_statements:
          dynamodb:
            effect: "Allow"
            actions:
              - "dynamodb:GetItem"
              - "dynamodb:PutItem"
              - "dynamodb:UpdateItem"
              - "dynamodb:DeleteItem"
              - "dynamodb:Query"
              - "dynamodb:Scan"
            resources:
              - "${output.serverless-api/dynamodb.table_arns.main}"
              - "${output.serverless-api/dynamodb.table_arns.main}/index/*"
          cognito:
            effect: "Allow"
            actions:
              - "cognito-idp:AdminGetUser"
              - "cognito-idp:AdminUpdateUserAttributes"
            resources:
              - "${output.serverless-api/cognito.user_pool_arn}"
          xray:
            effect: "Allow"
            actions:
              - "xray:PutTraceSegments"
              - "xray:PutTelemetryRecords"
            resources:
              - "*"

        # API Gateway integration
        api_gateway_source_arn: "${output.serverless-api/apigateway.execution_arn}/*/*/*"

        # Performance alarms
        create_performance_alarms: true
        duration_alarm_threshold: 25000  # 25 seconds
        error_rate_alarm_threshold: 5
        throttle_alarm_threshold: 10
        sns_topic_arn: "${alarm_sns_topic_arn}"

      tags:
        Layer: "compute"
        Function: "api-handler"

    serverless-api/lambda-authorizer:
      metadata:
        component: lambda
        type: real
      vars:
        function_name: "api-authorizer"
        description: "Custom API authorizer (optional)"

        # Runtime configuration
        runtime: "${lambda_runtime | default('python3.11')}"
        handler: "authorizer.handler"
        timeout: 10
        memory_size: 256

        # Architecture
        architectures:
          - "${lambda_architecture | default('arm64')}"

        # Reserved concurrency
        reserved_concurrent_executions: 50

        # Environment variables
        environment_variables:
          ENVIRONMENT: "${environment}"
          USER_POOL_ID: "${output.serverless-api/cognito.user_pool_id}"
          CLIENT_ID: "${output.serverless-api/cognito.client_ids.web}"

        # X-Ray tracing
        tracing_mode: "Active"

        # CloudWatch logs
        log_retention_days: "${log_retention_days | default(30)}"

        # API Gateway integration
        api_gateway_source_arn: "${output.serverless-api/apigateway.execution_arn}/authorizers/*"

      tags:
        Layer: "compute"
        Function: "authorizer"

    serverless-api/lambda-async-processor:
      metadata:
        component: lambda
        type: real
      depends_on:
        - serverless-api/dynamodb
        - serverless-api/sqs
      vars:
        function_name: "async-processor"
        description: "Processes async tasks from SQS"

        # Runtime configuration
        runtime: "${lambda_runtime | default('python3.11')}"
        handler: "processor.handler"
        timeout: 300
        memory_size: "${async_lambda_memory | default(1024)}"

        # Architecture
        architectures:
          - "${lambda_architecture | default('arm64')}"

        # Reserved concurrency
        reserved_concurrent_executions: "${async_lambda_concurrency | default(50)}"

        # Environment variables
        environment_variables:
          ENVIRONMENT: "${environment}"
          TABLE_NAME: "${output.serverless-api/dynamodb.table_names.main}"
          LOG_LEVEL: "${log_level | default('INFO')}"

        # SQS event source mapping
        event_source_mappings:
          sqs:
            event_source_arn: "${output.serverless-api/sqs.queue_arns.tasks}"
            batch_size: 10
            maximum_batching_window_in_seconds: 5
            function_response_types:
              - "ReportBatchItemFailures"

        # X-Ray tracing
        tracing_mode: "Active"

        # CloudWatch logs
        log_retention_days: "${log_retention_days | default(30)}"

        # Dead letter queue
        dead_letter_target_arn: "${output.serverless-api/sqs.queue_arns.dlq}"

        # IAM permissions
        policy_statements:
          dynamodb:
            effect: "Allow"
            actions:
              - "dynamodb:GetItem"
              - "dynamodb:PutItem"
              - "dynamodb:UpdateItem"
              - "dynamodb:Query"
            resources:
              - "${output.serverless-api/dynamodb.table_arns.main}"
          sqs:
            effect: "Allow"
            actions:
              - "sqs:ReceiveMessage"
              - "sqs:DeleteMessage"
              - "sqs:GetQueueAttributes"
            resources:
              - "${output.serverless-api/sqs.queue_arns.tasks}"
          sqs_dlq:
            effect: "Allow"
            actions:
              - "sqs:SendMessage"
            resources:
              - "${output.serverless-api/sqs.queue_arns.dlq}"

      tags:
        Layer: "compute"
        Function: "async-processor"

    # =========================================================================
    # DATA STORAGE (DynamoDB)
    # =========================================================================

    serverless-api/dynamodb:
      metadata:
        component: dynamodb
        type: real
      vars:
        tables:
          # Main application table (single-table design)
          main:
            name: "${tenant}-${environment}-api-data"
            billing_mode: "${dynamodb_billing_mode | default('PAY_PER_REQUEST')}"
            hash_key: "pk"
            range_key: "sk"
            attributes:
              - name: "pk"
                type: "S"
              - name: "sk"
                type: "S"
              - name: "gsi1pk"
                type: "S"
              - name: "gsi1sk"
                type: "S"
              - name: "gsi2pk"
                type: "S"
              - name: "gsi2sk"
                type: "S"
            global_secondary_indexes:
              - name: "gsi1"
                hash_key: "gsi1pk"
                range_key: "gsi1sk"
                projection_type: "ALL"
              - name: "gsi2"
                hash_key: "gsi2pk"
                range_key: "gsi2sk"
                projection_type: "KEYS_ONLY"
            local_secondary_indexes: []
            ttl:
              enabled: true
              attribute_name: "ttl"
            point_in_time_recovery: "${dynamodb_pitr | default(true)}"
            server_side_encryption:
              enabled: true
              kms_key_arn: "${dynamodb_kms_key_arn}"
            stream_enabled: "${dynamodb_streams | default(false)}"
            stream_view_type: "NEW_AND_OLD_IMAGES"
            # Contributor Insights for analysis
            contributor_insights_enabled: "${dynamodb_contributor_insights | default(false)}"
            # Auto-scaling (for PROVISIONED mode)
            autoscaling:
              enabled: "${dynamodb_autoscaling | default(false)}"
              read:
                min_capacity: 5
                max_capacity: 100
                target_utilization: 70
              write:
                min_capacity: 5
                max_capacity: 100
                target_utilization: 70

          # Sessions table (for API sessions/tokens)
          sessions:
            name: "${tenant}-${environment}-api-sessions"
            billing_mode: "PAY_PER_REQUEST"
            hash_key: "session_id"
            attributes:
              - name: "session_id"
                type: "S"
              - name: "user_id"
                type: "S"
            global_secondary_indexes:
              - name: "user-index"
                hash_key: "user_id"
                projection_type: "ALL"
            ttl:
              enabled: true
              attribute_name: "expires_at"
            point_in_time_recovery: false
            server_side_encryption:
              enabled: true

      tags:
        Layer: "data"
        Service: "dynamodb"

    # =========================================================================
    # MESSAGE QUEUES (SQS)
    # =========================================================================

    serverless-api/sqs:
      metadata:
        component: sqs
        type: real
      vars:
        queues:
          # Task processing queue
          tasks:
            name: "${tenant}-${environment}-api-tasks"
            visibility_timeout_seconds: 330  # Lambda timeout + buffer
            message_retention_seconds: 1209600  # 14 days
            max_message_size: 262144  # 256 KB
            delay_seconds: 0
            receive_wait_time_seconds: 20  # Long polling
            content_based_deduplication: false
            fifo_queue: false
            kms_master_key_id: "${sqs_kms_key_id}"
            kms_data_key_reuse_period_seconds: 300
            redrive_policy:
              dead_letter_target_arn: "dlq"
              max_receive_count: 3

          # Dead letter queue
          dlq:
            name: "${tenant}-${environment}-api-dlq"
            visibility_timeout_seconds: 60
            message_retention_seconds: 1209600  # 14 days
            kms_master_key_id: "${sqs_kms_key_id}"

          # Notifications queue
          notifications:
            name: "${tenant}-${environment}-api-notifications"
            visibility_timeout_seconds: 60
            message_retention_seconds: 86400  # 1 day
            kms_master_key_id: "${sqs_kms_key_id}"
            redrive_policy:
              dead_letter_target_arn: "dlq"
              max_receive_count: 5

      tags:
        Layer: "messaging"
        Service: "sqs"

    # =========================================================================
    # STATIC ASSETS (S3)
    # =========================================================================

    serverless-api/s3-assets:
      metadata:
        component: s3
        type: real
      vars:
        bucket_name: "${tenant}-${environment}-api-assets"
        description: "Static assets and user uploads"

        # Versioning
        versioning_enabled: true

        # Encryption
        server_side_encryption:
          sse_algorithm: "aws:kms"
          kms_master_key_id: "${assets_kms_key_id}"

        # CORS configuration
        cors_rules:
          - allowed_headers:
              - "*"
            allowed_methods:
              - "GET"
              - "PUT"
              - "POST"
            allowed_origins:
              - "https://${app_domain_name}"
              - "https://www.${app_domain_name}"
            expose_headers:
              - "ETag"
            max_age_seconds: 3600

        # Lifecycle rules
        lifecycle_rules:
          - id: "transition-uploads"
            enabled: true
            prefix: "uploads/"
            transitions:
              - days: 30
                storage_class: "STANDARD_IA"
              - days: 90
                storage_class: "GLACIER"
          - id: "expire-temp"
            enabled: true
            prefix: "temp/"
            expiration:
              days: 1

        # Access control
        block_public_access: true

        # Logging
        logging:
          target_bucket: "${log_bucket_name}"
          target_prefix: "s3-access-logs/assets/"

        # Object lock (for compliance)
        object_lock_enabled: "${enable_object_lock | default(false)}"

      tags:
        Layer: "storage"
        Service: "assets"

    # =========================================================================
    # CDN (CloudFront)
    # =========================================================================

    serverless-api/cloudfront:
      metadata:
        component: cloudfront
        type: real
      depends_on:
        - serverless-api/s3-assets
        - serverless-api/acm
      vars:
        distribution_name: "${tenant}-${environment}-api-assets-cdn"

        # Origins
        origins:
          s3:
            domain_name: "${output.serverless-api/s3-assets.bucket_regional_domain_name}"
            origin_id: "s3-assets"
            origin_access_control_id: "${oac_id}"
            s3_origin_config:
              origin_access_identity: ""

        # Default cache behavior
        default_cache_behavior:
          target_origin_id: "s3-assets"
          viewer_protocol_policy: "redirect-to-https"
          allowed_methods:
            - "GET"
            - "HEAD"
            - "OPTIONS"
          cached_methods:
            - "GET"
            - "HEAD"
          compress: true
          cache_policy_id: "658327ea-f89d-4fab-a63d-7e88639e58f6"  # CachingOptimized
          response_headers_policy_id: "67f7725c-6f97-4210-82d7-5512b31e9d03"  # SecurityHeadersPolicy
          function_associations: []

        # Custom error responses
        custom_error_responses:
          - error_code: 403
            response_code: 404
            response_page_path: "/404.html"
            error_caching_min_ttl: 300
          - error_code: 404
            response_code: 404
            response_page_path: "/404.html"
            error_caching_min_ttl: 300

        # SSL/TLS configuration
        viewer_certificate:
          acm_certificate_arn: "${output.serverless-api/acm.certificate_arns.assets}"
          ssl_support_method: "sni-only"
          minimum_protocol_version: "TLSv1.2_2021"

        # Aliases
        aliases:
          - "assets.${app_domain_name}"

        # Geographic restrictions
        geo_restriction:
          restriction_type: "none"

        # Logging
        logging:
          enabled: true
          bucket: "${log_bucket_name}.s3.amazonaws.com"
          prefix: "cloudfront-logs/assets/"
          include_cookies: false

        # Price class
        price_class: "${cloudfront_price_class | default('PriceClass_100')}"

        # HTTP/2 and HTTP/3
        http_version: "http2and3"

        # IPv6
        is_ipv6_enabled: true

      tags:
        Layer: "cdn"
        Service: "cloudfront"

    # =========================================================================
    # WAF
    # =========================================================================

    serverless-api/waf:
      metadata:
        component: waf
        type: real
      depends_on:
        - serverless-api/apigateway
      vars:
        name: "${tenant}-${environment}-api-waf"
        scope: "REGIONAL"

        # Associate with API Gateway
        resource_arn: "${output.serverless-api/apigateway.stage_arn}"

        # WAF rules
        managed_rule_groups:
          - name: "AWSManagedRulesCommonRuleSet"
            priority: 10
            override_action: "none"
            vendor_name: "AWS"
            excluded_rules: []
          - name: "AWSManagedRulesKnownBadInputsRuleSet"
            priority: 20
            override_action: "none"
            vendor_name: "AWS"
          - name: "AWSManagedRulesAmazonIpReputationList"
            priority: 30
            override_action: "none"
            vendor_name: "AWS"
          - name: "AWSManagedRulesSQLiRuleSet"
            priority: 40
            override_action: "none"
            vendor_name: "AWS"
          - name: "AWSManagedRulesAnonymousIpList"
            priority: 50
            override_action: "none"
            vendor_name: "AWS"

        # Rate limiting
        rate_based_rules:
          - name: "RateLimitPerIP"
            priority: 1
            limit: "${waf_rate_limit | default(2000)}"
            aggregate_key_type: "IP"
            action: "block"

        # Custom rules
        custom_rules:
          - name: "BlockBadUserAgents"
            priority: 5
            action: "block"
            statement:
              byte_match_statement:
                search_string: "curl/"
                field_to_match:
                  single_header:
                    name: "user-agent"
                positional_constraint: "STARTS_WITH"
                text_transformations:
                  - priority: 0
                    type: "LOWERCASE"

        # Logging
        enable_logging: true
        log_destination_arn: "${waf_log_destination_arn}"

        # CloudWatch metrics
        cloudwatch_metrics_enabled: true
        metric_name: "${tenant}-${environment}-api-waf"
        sampled_requests_enabled: true

      tags:
        Layer: "security"
        Service: "waf"

    # =========================================================================
    # DNS
    # =========================================================================

    serverless-api/dns:
      metadata:
        component: dns
        type: real
      depends_on:
        - serverless-api/cloudfront
        - serverless-api/api-domain
      vars:
        zone_id: "${route53_zone_id}"

        records:
          # Assets CDN
          assets:
            name: "assets.${app_domain_name}"
            type: "A"
            alias:
              name: "${output.serverless-api/cloudfront.domain_name}"
              zone_id: "${output.serverless-api/cloudfront.hosted_zone_id}"
              evaluate_target_health: false

      tags:
        Layer: "dns"
        Service: "route53"

    # =========================================================================
    # MONITORING
    # =========================================================================

    serverless-api/monitoring:
      metadata:
        component: monitoring
        type: real
        inherits:
          - monitoring/defaults
      depends_on:
        - serverless-api/apigateway
        - serverless-api/lambda-api-handler
        - serverless-api/dynamodb
        - serverless-api/cognito
      vars:
        dashboard_name: "${tenant}-${environment}-serverless-api-dashboard"

        # Enable monitoring features
        enable_resource_monitoring: true
        enable_cost_monitoring: "${enable_cost_monitoring | default(false)}"

        # Custom dashboard
        dashboards:
          api_overview:
            name: "${tenant}-${environment}-api-overview"
            widgets:
              # API Gateway metrics
              - type: "metric"
                properties:
                  title: "API Gateway Requests"
                  metrics:
                    - namespace: "AWS/ApiGateway"
                      metric: "Count"
                      dimensions:
                        ApiId: "${output.serverless-api/apigateway.api_id}"
                      stat: "Sum"
                      period: 60
                    - namespace: "AWS/ApiGateway"
                      metric: "4XXError"
                      dimensions:
                        ApiId: "${output.serverless-api/apigateway.api_id}"
                      stat: "Sum"
                      period: 60
                    - namespace: "AWS/ApiGateway"
                      metric: "5XXError"
                      dimensions:
                        ApiId: "${output.serverless-api/apigateway.api_id}"
                      stat: "Sum"
                      period: 60

              # Lambda metrics
              - type: "metric"
                properties:
                  title: "Lambda Performance"
                  metrics:
                    - namespace: "AWS/Lambda"
                      metric: "Duration"
                      dimensions:
                        FunctionName: "${output.serverless-api/lambda-api-handler.function_name}"
                      stat: "p99"
                      period: 60
                    - namespace: "AWS/Lambda"
                      metric: "Invocations"
                      dimensions:
                        FunctionName: "${output.serverless-api/lambda-api-handler.function_name}"
                      stat: "Sum"
                      period: 60
                    - namespace: "AWS/Lambda"
                      metric: "Errors"
                      dimensions:
                        FunctionName: "${output.serverless-api/lambda-api-handler.function_name}"
                      stat: "Sum"
                      period: 60

              # DynamoDB metrics
              - type: "metric"
                properties:
                  title: "DynamoDB Operations"
                  metrics:
                    - namespace: "AWS/DynamoDB"
                      metric: "ConsumedReadCapacityUnits"
                      dimensions:
                        TableName: "${output.serverless-api/dynamodb.table_names.main}"
                      stat: "Sum"
                      period: 60
                    - namespace: "AWS/DynamoDB"
                      metric: "ConsumedWriteCapacityUnits"
                      dimensions:
                        TableName: "${output.serverless-api/dynamodb.table_names.main}"
                      stat: "Sum"
                      period: 60

              # Cognito metrics
              - type: "metric"
                properties:
                  title: "Authentication"
                  metrics:
                    - namespace: "AWS/Cognito"
                      metric: "SignInSuccesses"
                      dimensions:
                        UserPool: "${output.serverless-api/cognito.user_pool_id}"
                      stat: "Sum"
                      period: 300
                    - namespace: "AWS/Cognito"
                      metric: "SignUpSuccesses"
                      dimensions:
                        UserPool: "${output.serverless-api/cognito.user_pool_id}"
                      stat: "Sum"
                      period: 300

        # Alarms
        alarms:
          # API Gateway alarms
          api_5xx_errors:
            name: "${tenant}-${environment}-api-5xx-errors"
            metric_name: "5XXError"
            namespace: "AWS/ApiGateway"
            comparison_operator: "GreaterThanThreshold"
            threshold: 10
            evaluation_periods: 2
            period: 300
            statistic: "Sum"
            dimensions:
              ApiId: "${output.serverless-api/apigateway.api_id}"

          api_4xx_errors:
            name: "${tenant}-${environment}-api-4xx-errors"
            metric_name: "4XXError"
            namespace: "AWS/ApiGateway"
            comparison_operator: "GreaterThanThreshold"
            threshold: 100
            evaluation_periods: 2
            period: 300
            statistic: "Sum"
            dimensions:
              ApiId: "${output.serverless-api/apigateway.api_id}"

          api_latency:
            name: "${tenant}-${environment}-api-latency"
            metric_name: "Latency"
            namespace: "AWS/ApiGateway"
            comparison_operator: "GreaterThanThreshold"
            threshold: 5000  # 5 seconds
            evaluation_periods: 3
            period: 300
            statistic: "p99"
            dimensions:
              ApiId: "${output.serverless-api/apigateway.api_id}"

          # Lambda alarms
          lambda_errors:
            name: "${tenant}-${environment}-lambda-errors"
            metric_name: "Errors"
            namespace: "AWS/Lambda"
            comparison_operator: "GreaterThanThreshold"
            threshold: 5
            evaluation_periods: 2
            period: 300
            statistic: "Sum"
            dimensions:
              FunctionName: "${output.serverless-api/lambda-api-handler.function_name}"

          lambda_throttles:
            name: "${tenant}-${environment}-lambda-throttles"
            metric_name: "Throttles"
            namespace: "AWS/Lambda"
            comparison_operator: "GreaterThanThreshold"
            threshold: 0
            evaluation_periods: 1
            period: 60
            statistic: "Sum"
            dimensions:
              FunctionName: "${output.serverless-api/lambda-api-handler.function_name}"

          # DynamoDB alarms
          dynamodb_throttled:
            name: "${tenant}-${environment}-dynamodb-throttled"
            metric_name: "ThrottledRequests"
            namespace: "AWS/DynamoDB"
            comparison_operator: "GreaterThanThreshold"
            threshold: 0
            evaluation_periods: 1
            period: 60
            statistic: "Sum"
            dimensions:
              TableName: "${output.serverless-api/dynamodb.table_names.main}"

          # SQS DLQ alarm
          dlq_messages:
            name: "${tenant}-${environment}-dlq-messages"
            metric_name: "ApproximateNumberOfMessagesVisible"
            namespace: "AWS/SQS"
            comparison_operator: "GreaterThanThreshold"
            threshold: 0
            evaluation_periods: 1
            period: 300
            statistic: "Sum"
            dimensions:
              QueueName: "${output.serverless-api/sqs.queue_names.dlq}"

        # SNS notifications
        alarm_notifications_enabled: true
        alarm_email_addresses: "${alarm_email_addresses | default([])}"
        sns_topic_name: "${tenant}-${environment}-serverless-api-alarms"

      tags:
        Layer: "monitoring"
        Service: "cloudwatch"

# =============================================================================
# ENVIRONMENT-SPECIFIC OVERRIDES
# =============================================================================
#
# Development:
#   vars:
#     api_type: "HTTP"  # Cheaper than REST
#     lambda_runtime: "python3.11"
#     lambda_architecture: "arm64"
#     api_lambda_memory: 256
#     api_lambda_concurrency: 10
#     dynamodb_billing_mode: "PAY_PER_REQUEST"
#     dynamodb_pitr: false
#     log_retention_days: 7
#     mfa_configuration: "OFF"
#     advanced_security_mode: "OFF"
#     cloudfront_price_class: "PriceClass_100"
#
# Staging:
#   vars:
#     api_type: "REST"
#     lambda_architecture: "arm64"
#     api_lambda_memory: 512
#     api_lambda_concurrency: 50
#     dynamodb_billing_mode: "PAY_PER_REQUEST"
#     dynamodb_pitr: true
#     log_retention_days: 14
#     mfa_configuration: "OPTIONAL"
#     advanced_security_mode: "AUDIT"
#     cloudfront_price_class: "PriceClass_100"
#
# Production:
#   vars:
#     api_type: "REST"
#     lambda_architecture: "arm64"
#     api_lambda_memory: 1024
#     api_lambda_concurrency: 200
#     async_lambda_concurrency: 100
#     dynamodb_billing_mode: "PROVISIONED"
#     dynamodb_pitr: true
#     dynamodb_autoscaling: true
#     dynamodb_streams: true
#     dynamodb_contributor_insights: true
#     log_retention_days: 90
#     mfa_configuration: "ON"
#     advanced_security_mode: "ENFORCED"
#     cognito_deletion_protection: "ACTIVE"
#     cloudfront_price_class: "PriceClass_All"
#     api_burst_limit: 10000
#     api_rate_limit: 20000

# =============================================================================
# REQUIRED VARIABLES
# =============================================================================
# app_domain_name: "example.com"
# route53_zone_id: "Z1234567890ABC"
# dynamodb_kms_key_arn: "arn:aws:kms:..."
# sqs_kms_key_id: "alias/aws/sqs"
# assets_kms_key_id: "arn:aws:kms:..."
# lambda_logs_kms_key_id: "arn:aws:kms:..."
# lambda_powertools_layer_arn: "arn:aws:lambda:..."
# log_bucket_name: "my-log-bucket"
# waf_log_destination_arn: "arn:aws:s3:::..."
# alarm_email_addresses: ["ops@example.com"]
#
# Optional:
# vpc_id: "vpc-xxx" (for VPC-connected Lambda)
# private_subnet_ids: ["subnet-xxx"]
# ses_source_arn: "arn:aws:ses:..." (for custom email)
# from_email_address: "noreply@example.com"
# oac_id: "xxx" (CloudFront Origin Access Control)
